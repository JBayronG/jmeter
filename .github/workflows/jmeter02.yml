name: JMeter Performance Test

on:
  push:
    branches: [ "master" ]

  workflow_dispatch:
    inputs:
      users:
        description: "Usuarios concurrentes"
        default: "500"
      initial_delay:
        description: "Delay inicial (seg)"
        default: "0"
      start_users:
        description: "Usuarios por escalÃ³n"
        default: "40"
      start_burst:
        description: "Usuarios por burst"
        default: "40"
      start_period:
        description: "Periodo subida (seg)"
        default: "60"
      stop_users:
        description: "Usuarios a bajar por paso"
        default: "40"
      stop_period:
        description: "Periodo bajada (seg)"
        default: "30"
      flighttime:
        description: "Tiempo total activo (seg)"
        default: "600"
      rampup:
        description: "RampUp interno (seg)"
        default: "10"

jobs:
  run-jmeter:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: '11'

    - name: Install JMeter
      run: |
        JMETER_VERSION=5.6.3
        wget https://downloads.apache.org/jmeter/binaries/apache-jmeter-${JMETER_VERSION}.tgz
        tar -xzf apache-jmeter-${JMETER_VERSION}.tgz
        echo "JMETER_HOME=$(pwd)/apache-jmeter-${JMETER_VERSION}" >> $GITHUB_ENV

     #  Instalar JMeter Plugins (Stepping Thread Group)
    - name: Install JMeter Plugins (Stepping Thread Group)
      run: |
        wget https://repo1.maven.org/maven2/kg/apc/jmeter-plugins-manager/1.9/jmeter-plugins-manager-1.9.jar \
          -O $JMETER_HOME/lib/ext/jmeter-plugins-manager.jar

        wget https://repo1.maven.org/maven2/kg/apc/cmdrunner/2.3/cmdrunner-2.3.jar \
          -O $JMETER_HOME/lib/cmdrunner-2.3.jar

        java -jar $JMETER_HOME/lib/cmdrunner-2.3.jar \
          --tool org.jmeterplugins.repository.PluginManagerCMD \
          install jpgc-casutg


    # ðŸ”¹ PASO CLAVE
    - name: Resolve parameters
      run: |
        echo "USERS=${{ inputs.users || '500' }}" >> $GITHUB_ENV
        echo "INITIAL_DELAY=${{ inputs.initial_delay || '0' }}" >> $GITHUB_ENV
        echo "START_USERS=${{ inputs.start_users || '40' }}" >> $GITHUB_ENV
        echo "START_BURST=${{ inputs.start_burst || '40' }}" >> $GITHUB_ENV
        echo "START_PERIOD=${{ inputs.start_period || '60' }}" >> $GITHUB_ENV
        echo "STOP_USERS=${{ inputs.stop_users || '40' }}" >> $GITHUB_ENV
        echo "STOP_PERIOD=${{ inputs.stop_period || '30' }}" >> $GITHUB_ENV
        echo "FLIGHTTIME=${{ inputs.flighttime || '600' }}" >> $GITHUB_ENV
        echo "RAMPUP=${{ inputs.rampup || '10' }}" >> $GITHUB_ENV

        echo "Usuarios=$USERS"
        echo "InitialDelay=$INITIAL_DELAY"
        echo "StartUsers=$START_USERS"
        echo "StartBurst=$START_BURST"
        echo "StartPeriod=$START_PERIOD"
        echo "StopUsers=$STOP_USERS"
        echo "StopPeriod=$STOP_PERIOD"
        echo "FlightTime=$FLIGHTTIME"
        echo "RampUp=$RAMPUP"

    - name: Run JMeter Test
      run: |
        mkdir -p results

        $JMETER_HOME/bin/jmeter -n \
          -t guru99v3.jmx \
          -l results/results.jtl \
          -Jusers=$USERS \
          -Jinitial_delay=$INITIAL_DELAY \
          -Jstart_users=$START_USERS \
          -Jstart_burst=$START_BURST \
          -Jstart_period=$START_PERIOD \
          -Jstop_users=$STOP_USERS \
          -Jstop_period=$STOP_PERIOD \
          -Jflighttime=$FLIGHTTIME \
          -Jrampup=$RAMPUP

    - name: Generate HTML report
      run: |
        $JMETER_HOME/bin/jmeter \
          -g results/results.jtl \
          -o results/html

    - name: Upload results
      uses: actions/upload-artifact@v4
      with:
        name: jmeter-results
        path: results
